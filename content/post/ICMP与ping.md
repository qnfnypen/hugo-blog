+++
title="（五）ICMP与ping"
date=2020-03-17T11:52:20+08:00
categories=["网络协议"]
description="投石问路的侦察兵"
toc=false
+++

无论是在宿舍，还是在办公室或者一共运维的数据中心，我们常常会遇到网络不通的问题。拿台机器明明就在那里，你甚至都可以通过机器的终端练上去看。它看着好好的，可是就是连不上去，究竟哪里除了问题呢？

### ICMP协议的格式
一般情况下，我们会去ping一下。那么ping是如何工作的呢？

ping是基于ICMP协议工作的。**ICMP**全称是**Internet Control Message Protocol**，就是**互联网控制报文协议**。这里面的关键字是“控制”，那具体是怎么控制的呢？

ICMP报文是封装在IP包里面的。因为传输指令的时候，肯定需要源地址和目标地址。它本事非常简单。因为作为侦察兵，要轻装上阵，不能携带大量的包袱。
![](https://pic.downk.cc/item/5e704f50e83c3a1e3aebec0d.png)
ICMP报文有很多类型，不同的类型有不同的代码。**最常用的类型是主动请求为8，主动请求的应答为0**。

### 查询报文类型
常用的ping就是查询报文，是一种主动请求，并且获得主动应答的ICMP协议。所以，ping发的包也是符合ICMP协议格式的，只不过它在后面增加了自己的格式。

对于ping的主动请求，进行网络抓包，称为**ICMP ECHO REQUEST**。同理，主动请求的回复称为**ICMP ECHO REPLY**。相比原生的ICMP，这里面多了两个字段，一个是**标识符**，例如派出去的侦察兵，一个是侦察战况的，一共是查找水源的，要有个标识才能区分。另一个是**序号**，派出去的侦察兵都要有个编号，如果派出去10个，回来10个，就说明前方战况不错；如果派出去10个，回来2个，说明情况可能不妙。

在选项数据中，ping还会存放发送请求的时间值，来计算往返时间，说明路程的长短。

### 差错报文类型
这种是异常情况发起的，来报告发生了不好的事情。列举几个ICMP差错报文的例子：**终点不可达为3，源抑制为4，超时为11，重定向为5**。
1. 终点不可达
    + 网络不可达代码为0
    + 主机不可达代码为1
    + 协议不可达代码为2
    + 端口不可达代码为3
    + 需要进行分片但设置了不分片代码为4
2. 源站抑制：让源站放慢发送速度
3. 时间超时：超过网络包的生存时间还是没到
4. 路由重定向：也就是下次让发给另一共路由器

差错报文的结构相对复杂一些。除了前面还是IP，ICMP的前8字节不变，后面则跟上出错的那个IP包的IP头和IP正文前8个字节。

### ping：查询报文类型的使用
![](https://pic.downk.cc/item/5e7065c2e83c3a1e3afeb202.png)
假定主机A的IP地址是192.168.1.1，主机B的IP地址是192.168.1.2。它们都在同一个子网，当你在主机A上运行“ping 192.168.1.2”后，会发生什么呢？

ping命令执行的时候，源主机首先会构建一个ICMP请求数据包，ICMP数据包内包含多字段。最重要的是两个，第一个是**类型字段**，对于请求数据包而言该字段为8；另一共是**顺序号**，主要用于区分连续ping的时候发出的多个数据包。每发出一共请求数据包，顺序号会自动加1.为了能够计算往返时间RTT，它会在报文的数据部分插入发送时间。

然后，由ICMP协议将这个数据包连同地址192.138.1.2一起交给IP层。IP层将以192.168.1.2为目标地址，本机IP地址作为源地址，加上一些其他控制信息，构建一个IP数据包。

接下来，需要加入MAC头。如果在ARP映射表中查找出IP地址192.168.1.2所对应的MAC地址，则可以直接使用（直接发送数据包）；如果没有，则需要发送ARP协议查询MAC地址，获得MAC地址后，有数据链路层构建一个数据帧，目的地址是IP层传过来的MAC地址，源地址是本机的MAC地址；还要附加上一些控制信息，依据以太网的介质访问规则，将它们传送出去。

主机B接收到这个数据帧后，先检查它的目的MAC地址，并和本机的MAC地址对比，如符合，则接收，否则就丢弃。接收后检查该数据帧，将IP数据包从帧中提取出来，交给本机IP层。同样，IP层检查后，将有用的信息提取后交给ICMP协议。

主机B会构建一个ICMP应答包，应答数据包的类型字段为0，顺序号为接收到的请求数据包中的顺序号，然后再发送出去给主机A。

在规定时间内，源主机如果没有接到ICMP的应答包，则说明目标主机不可达；如果接收到了ICMP应答包，则说明目标主机可达。此时，源主机会去查，用当前时刻减去该数据包最初从源主机上发出的时刻，就是ICMP数据包的时间延迟。

当然这只是最简单的，如果涉及跨网段的话，还会涉及网关的转发、路由器的转发等等。但是对于ICMP的头来讲，是没什么影响的。会影响的是根据目标IP地址，选择路由的下一跳，华语每经过一个路由器到达一个新的局域网，需要换MAC头里面的MAC地址。

我们可以看出ping这个程序是使用了ICMP里面的ECHO REQUEST和ECHO REPLY类型的。

### Traceroute：差错报文类型的使用
1. **故意设置特殊的TTL，来追踪去往目的地沿途经过的路由器**
2. **故意设置不分片，从而确定路径的MTU**
