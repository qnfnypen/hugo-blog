+++
title="（六）网关"
date=2020-03-18T00:33:04+08:00
categories=["网络协议"]
toc=false
+++

### 如何使得局域网中的电脑可以上网
1. 找一台双网卡的电脑，一张卡网接局域网，另一张网卡接外网，当然新的外网的网卡的IP地址要按照分配的进行配置。这种情况下，这台电脑就相当于一个路由器。需要一直开着。
2. 买一台路由器，路由器会有内网网口和外网接口。

当使用第一种方法使得这台电脑可以上网的时候，接下来就是其它电脑如何上网的问题。这就需要配置其他电脑的**网卡**。**当然DHCP（动态主机配置协议）是可以默认配置的。在进行网卡配置的时候，除了IP地址，还需要配置一个Gateway**的东西，这个就是**网关**。

### 你了解MAC头和IP头的细节吗？
一旦配置了IP地址和网关，往往就能够指指定目标地址进行访问了。由于在跨网关访问的时候，牵扯到MAC地址和IP地址的变化，这里有必要详细描述一下MAC头和IP头的细节。
![](https://pic.downk.cc/item/5e758ddf9d7d586a549f0179.jpg)
在MAC头里面，先是目标MAC地址，然后是源MAC地址，然后有一个协议类型，用来说明里面是IP协议。IP头里面的版本号，目前主流的还是IPv4，服务类型TOS，主要说明当前包的优先级，TTL表示包允许通过的最大网段数量。另外，还有8位标识协议，也就是下一层（传输层）的协议，也就是，是TCP还是UDP。最重要的就是源IP和目标IP。先是源IP地址，然后是目标IP地址。

在任何一台机器上，当要访问另一个IP地址的时候，都会先判断，这个目标IP地址和源目标IP地址，是否在同一个网段，也就是网络号是否一致。

**如果是同一个网段**，那就没网关什么事情，直接将源地址和目标地址放入IP头中，然后通过ARP广播获得MAC地址，将源MAC和目的MAC放入MAC头中，发出去就可以了。

**如果不是同一个网段**，这就需要发往默认网关Gateway。Gateway的地址一定是和源IP地址是一个网段的。往往不是第一个，就是第二个。例如192.138.1.0/24这个网段，Gateway往往会是192.168.1.1/24或者192.168.1.2/24。

如何发往默认网关呢？网关不是和源IP地址是一个网段的么？这个过程就和发往同一个网段的其他机器是一样的：将源地址和目标IP地址放入IP头中，通过ARP获得网关的MAC地址，将源MAC和网关的MAC放入MAC头中，发送出去。

**网关往往是一个路由器，是一个三层转发的设备**。一个路由器往往有多个网口，如果是一台服务器做这个事情，则就是多个网卡，其中一个网卡是和源IP同网段的（属于局域网的）。很大情况下，人们把网关就叫做路由器。其实不完全准确，而另一种比喻更加恰当：**路由器是一台设备，它有五个网口或者网卡，相当于五只手，分别连着五个局域网。每只手的IP地址都和局域网的IP地址是相同的网段，每只手都是它握住的那个局域网的网关。**

任何一个想发往其他局域网的包，都会到达其中一只手，被拿进来，拿下MAC头和IP头看看，根据自己的路由算法，选择另一只手，加上IP头和MAC头，然后扔出去。

### 静态路由是什么？
**静态路由，其实就是在路由器上，配置一条一条规则**。

### IP头和MAC头哪些变、哪些不变？
可以分为两种情况：一个是目标IP地址不改变。
MAC地址是一个局域网内才有效的地址。因而，MAC地址只要过网关，就必定会改变，因为已经换了局域网。两者主要的区别在于IP地址是否改变。不改变IP地址的网关，我们称为**转发网关**；**改变IP地址的网关，我们称为NAT网关**。

#### 1.目标IP地址不变，MAC地址改变
![](https://pic.downk.cc/item/5e75bcf89d7d586a54c7db79.jpg)
服务器A想要访问服务器B。首先，服务器A会思考，192.168.4.101/24和我是不是一个网段的，因而需要先发给网关。网关已经静态配置好了，网关是192.168.1.1/24。网关的MAC地址是多少呢？发送ARP获取网关的MAC地址，然后发送包，包的内容是这样的：
  + 源MAC：服务器A的MAC
  + 目标MAC：192.168.1.1这个网口的MAC
  + 源IP：192.168.1.101
  + 目标IP：192.168.4.101

包到达192.168.1.1这个网口，发现MAC一致，将包收进来，开始思考往哪里转发。在路由器A中配置了静态路由之后，要想访问192.168.4.0/24，要从192.168.56.1这个口出去，下一跳为192.168.56.2。于是路由器A匹配上这条路由，要从192.168.56.1这个口出去，发给192.168.56.2，通过ARP广播获取其MAC地址。然后发送包：
  + 源MAC：192.168.56.1的MAC
  + 目标MAC：192.168.56.2这个网口的MAC
  + 源IP：192.168.1.101
  + 目标IP：192.168.4.101 

包达到192.168.56.2这个网口，发现MAC一致，将包收进来，开始思考往哪里转发。由于路由器B配置了静态路由，要想访问192.168.4.0/24，要从192.168.4.1这个口出去，没有下一跳了。于是，路由器B匹配上了这条路由，从192.168.4.1/24这个口发出去，发给192.168.4.101/24，通过ARP广播获取其MAC地址。然后发送包：
  + 源MAC：192.168.4.1/24的MAC
  + 目标MAC：192.168.4.101/24这个网口的MAC
  + 源IP：192.168.1.101
  + 目标IP：192.168.4.101

通过这个过程可以看出，每到一个新的局域网，MAC都要改变的，但是IP地址都不变。在IP头里面，不会保存任何网关的IP地址。**所谓的下一跳是，某个IP要将这个IP地址转换为MAC放入MAC头**。

#### 2.IP地址改变，MAC地址改变
这里遇到的第一个问题就是，局域网之间没有商量过，各定各的网段，因而IP段冲突了。例如局域网1的192.168.1.101想要访问局域网2的192.168.1.101。如果单从IP地址上看，简直就是自己在访问自己。

既然局域网之间没有商量过，那到国际上，也即中间的局域网里面，就需要使用另外的地址。所以要给目标服务器B分配一个国际身份，192.168.56.2/24。当收到包后，由路由器B做NAT，转换为国内身份。为了让包可以成功返回，所以源服务器A也是需要一个国际身份的。

从这个过程可以看出，IP地址也会变。这个过程用英文说就是**Network Address Translation**，简称**NAT**。

其实这第二种方式我们经常见，现在的家用路由器，都是这种方式。所以，当我们家里的包发出去的时候，都被家用路由器NAT成为了运营商的地址了。

很多办公室访问外网的时候，也是被NAT过的，因为不可能办公室里面的IP也是公网可见的，所以一般就是整个办公室共用一个到两个出口IP地址。可以通过[https://www.whatismyip.com/](https://www.whatismyip.com/)查看自己的出口IP地址。
