+++
title="（四）交换机与VLAN"
date=2020-03-16T23:49:00+08:00
categories=["网络协议"]
toc=false
+++

### 拓扑结构是怎么形成的？
当有几十个甚至上百个网口，一个交换机肯定不够用，需要多台交换机，交换机之间连接起来，就形成一个稍微复杂的**拓扑结构**。

我们先来看**两台交换机**的情形。两台交换机连接着三个局域网，每个局域网上都有多台机器。如果机器1知道机器4的IP地址，当它想要访问机器4，把包发出去的时候，它必须要知道机器4的MAC地址。
![](https://pic.downk.cc/item/5e6fa2d9e83c3a1e3aaa5ee8.png)
注意：这里的LAN2中还有其他机器，为了简化只画了一台机器。
于是机器1发起广播，机器2收到这个广播，知道这不是找它的。交换机A一开始是不知道任何拓扑信息的，在它收到这个广播后，采取的策略是，除了广播包来的方向外，它还要转发给其他所有的网口。于是机器3也收到了广播信息了，但是这和它也没什么关系。交换机B接收到广播信息后也是不知道任何拓扑信息的，因而是进行广播的策略，将包转发到局域网三。这个时候，机器4和机器5都收到了广播信息。机器4主动响应说，这是找我的，这是我的MAC地址。于是一个ARP请求就成功完成了。

当机器3要访问机器1的时候，也需要发起一个广播的ARP请求。这个时候交换机A和交换机B都能够收到这个广播请求。交换机A知道主机A是在左边这个网口的，所以把广播消息转发到局域网一。同时交换机B收到这个广播消息之后，由于它知道机器1是不在右边这个网口的，所以不会将消息广播到局域网三。

### 如何解决常见的环路问题？
![](https://pic.downk.cc/item/5e6fa990e83c3a1e3aafaab6.png)
当机器1访问机器2的时候，机器1并不知道机器2的MAC地址，所以它需要发送一个ARP广播包，广播到达机器2，机器2把MAC地址返回来。

同时交换机A和交换机B都可以接收到广播包。交换机A一开始不知道机器2在哪个局域网，于是它把广播包转发到局域网2，在局域网二广播的时候，交换机B右边的网口也是能够收到广播消息的，交换机B又把广播包转发到局域网一。交换机A又接收到广播信息。

### STP协议中那些难以理解的概念
在数据结构中，有一个方法叫做**最小生成树**。有环的我们常称为**图**。将图中的环破了，就生成了**树**。在计算机网络中，生成树的算法叫做**STP**，全称**Spanning Tree Protocol**
![](https://pic.downk.cc/item/5e6facace83c3a1e3ab2554e.jpg)
在STP协议里面有很多概念：
+ **Root Bridge**：根交换机。可以理解为树的根，门派的掌门，最大的大哥
+ **Designated Bridges**：指定交换机。对于树来说，就是一棵树的树枝。所谓“指定的”的意思是，我拜谁做大哥，其他交换机通过这个交换机到达根交换机，也就相当于拜他做了大哥。注意，这里是树枝而不是叶子，因为叶子往往是主机
+ **Bridge Protocol Data Units（BPDU）**：网桥协议数据单元。可以比喻为“相互比较实力”的协议。行走江湖，比的就是武功，拼的就是实力。当两个交换机碰见的时候，也就是相连的时候，就需要相互比一下实力了。BPDU只有掌门能发，已经隶属于某个掌门的交换机只能传达掌门的指示
+ **Priority Vector**：优先级向量。可比喻为实力（值越小越厉害）。实力是什么？就是一组ID数目，[Root Bridge ID,Root Path Cost,Bridge ID,Port ID]。为什么这样设计呢？这是因为要看怎么来比实力。先看Root Bridge，拿出老大的ID看看，发现一样；再比Root Path Cost，也就是我距离我的老大的距离，看看谁离老大近；最后比Bridge ID，比自己的ID，用自己的本事比。

### STP的工作过程是怎样的？
一开始，江湖纷争，大家都觉得自己老大，谁也不服谁。每个网桥都被分配了一个ID。这个ID是管理员分配的优先级，网络管理员知道哪些交换机贵，哪些交换机好，就会给它们分配高的优先级。

既然都是老大，互相都连着网线，那就互相发送BPDU来比实力，赢的人做老大，输的做小弟。当老大的还会继续发BPDU，而输的人就没机会了，只能在收到老大发的BPDU的时候，转发一下，表示服从命令。
![](https://pic.downk.cc/item/5e703172e83c3a1e3adb4646.jpg)
数字表示优先级，越小越厉害，5碰见6，6的优先级低，所以乖乖做小弟，于是一个门派形成了，5是掌门，6是小弟。其他诸如1-7，2-8，3-4这样的小门派，也诞生了。于是江湖出现很多小门派，小的门派接着合并。

合并的过程会出现以下四种情形：
1. **掌门遇到掌门**
当5碰到了1，这两个掌门比较功夫，最终1胜出。于是输掉的5就会率领所有的小弟归顺，结果就是1成为了大掌门。

2. **同门相遇**
同门相遇可以是掌门与自己的小弟相遇，这说明存在“环”了。就PK了一把。结果掌门发现这个小弟功夫还不错，不应该级别这么低，就把它招到门下亲自带，那这个小弟就相当于升职了。
<br/>我们再来看，假如1和6相遇。6原来就拜在1的门下，只不过6的上司是5，5的上司是1。1发现，6距离自己才2，比从5这里过来的5（=4+1）近多了，那6就直接向汇报给我吧。于是，5和6分别汇报给1。
<br/>同门相遇还可以是小弟相遇。这个时候就看谁距离老大近了，刚才5和6同时汇报给1，后来5和6再比较功夫的时候发现，5直接汇报给1的距离是4，如果5汇报给6再汇报给1，距离就是2+1=3，所以5干脆拜6为上司。

3. **掌门与其他帮派小弟相遇**
小弟拿本帮掌门和这个掌门比较，赢了，这个掌门拜入门来。输了，会拜入新掌门，并且逐渐拉拢和自己连接的兄弟，一起弃暗投明。
<br/>例如，2和7相遇，虽然7是小弟，2是掌门。就个人武功而言，2比7强，但是7的掌门是1，比2牛，所以没办法，2要拜入7的门派，并且连同自己的小弟都一起拜入。

4. **不同门派小弟相遇**
各自拿掌门比较，输了的拜入赢的门派，并且逐渐将与自己连接的兄弟弃暗投明。最终，生成一棵树，天下太平。但是天下大势，分久必合，合久必分，天下一统了，也会有相应的问题。

### 如何解决广播问题和安全问题
当机器和交换机多了，由于在同一个广播域里面，很多包都会在一个局域网里面，碰到一个会抓包的程序员，就能抓到这些包，如果没有加密，就能看到这些敏感信息了。就好比一个公司，所有人不同部门都在一起讨论。

那怎么办，分部门，分会议室呗。
+ **物理隔离**：每个部门设一个单独的会议室，对应到网络方面，就是每个部门有单独的交换机，配置单独的子网，这样部门之间的沟通就需要路由器了。这样的问题在于，部门的人员不是一成不变的。如果每个部门有单独的交换机，口多了浪费，少了又不够用。
+ **虚拟隔离（VLAN）**：或者叫**虚拟局域网**。使用VLAN交换机上会连属于多个局域网的机器，那交换机怎么区分哪个机器属于哪个局域网呢？
![](https://pic.downk.cc/item/5e704235e83c3a1e3ae219ef.png)
我们只需要在原来的二层的头上加一个TAG，里面有一个VLAN ID，一共12位。就目前的情况证明，这样还是不够的。如果我们买的交换机是支持VLAN的，当这个交换机把二层的头取下来的时候，就能够识别这个VLAN ID。这样只有相同的VLAN包，才会互相转发，不同VLAN的包是看不到的。这样广播问题和安全问题就都能够解决了。

我们可以设置交换机每个口所属的VLAN。例如某个口坐的是人事，属于VLAN 20；某个口坐的是财务，属于VLAN 30。而且对于交换机来讲，每个VLAN的口都是可以重新设置的。一个财务走了可以把他的口从VLAN 30移除掉，来了一个人事，就把这个口设置为VLAN 20，十分灵活。

那么交换机之间怎么连接呢？将两个交换机连起来的口应该设置成什么VLAN呢？对于支持VLAN的交换机，有一种口叫做**Trunk口**。它可以转发属于任何VLAN的口。交换机之间可以通过这种口相互连接。
