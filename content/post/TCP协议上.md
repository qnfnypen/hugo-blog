+++
title="（九）TCP协议上"
date=2020-03-21T19:35:14+08:00
categories=["网络协议"]
toc=false
+++

### TCP包头格式
![](https://pic.downk.cc/item/5e79c9919dbe9d88c5e27273.jpg)
首先，源端口号和目标端口号是不可少的，这一点和UDP是一样的。如果没有这两个端口号。数据就不知道应该发给哪个应用。
+ 序号：为了解决乱序的问题
+ 确认序号：确认对方有没有收到包
+ 状态位：SYN发起一个连接，ACK回复，RST重新连接、FIN结束连接
+ 窗口大小：流量控制

### TCP的三次握手
TCP的连接建立，我们常常称为三次握手：
A：你好，我是A
B：你好，我是B
A：你好B
我们也常称为“请求 -> 应答 -> 应答之应答”。那为什么是三次，而不是两次？打招呼一来一回不就可以了吗？如果为了可靠为什么不是四次呢？

我们假设网络是不可靠的，A要发起一个连接，当发了第一个请求没有消息的时候，会有很多的可能性，比如丢包了，超时了，B没有响应。A不难确认结果，于是继续发。终于B回复了请求，发送了一个应答包。但是B并不能确定A是否收到应答包，所以B不能认为已经建立连接了。所以两次握手肯定不可以。

A收到B的应答之后，发给B一个应答之应答。当然按理说还有应答之应答之应答。但是这样就没有底了。这样下去不管多少次也并不能真的保证连接的可靠性。只要双方的消息都有去有会，就基本可以了。所以三次是最基本的。

### TCP四次挥手
A：B，我不想玩了
B：哦，我知道了
这个时候，还只是A不想玩了，也即A不会再发送数据，但是B能不能在ACK的时候，直接关闭呢？当然不可以，很有可能是A做完了自己的事情，但是B还没有，还是可以发送数据的，所以称为半关闭状态。

这个时候A可以选择不再接收数据，也可以选择最后再接收一段数据，等B也主动关闭。
B：A，我也不想玩了
A：好的
这样整个连接就关闭了。