+++
title="（三）从物理层到MAC层"
date=2020-03-15T12:08:53+08:00
categories=["网络协议"]
description="在宿舍中如何组网玩游戏"
toc=false
+++

### 第一层（物理层）
要使得电脑连电脑，除了使用路由器（作用于三层），还可以使用网线。这种方式就是一根网线，一头插在电脑的网卡上，另一头插在另一台电脑的网卡上。但是普通的网线（直通线）是不可以的，所以水晶头要做交叉线，用的就是所谓的**1-3、2-6交叉接法**。

水晶头的第1、2和第3、6脚，它们分别起着收、发信号的作用。将一端的1号线和3号线、2号线和6号线互换一下位置，就能够在物理层实现一端发送的信号，另一端能收到。

当然电脑连电脑，除了网线要交叉，还需要配置这两台电脑的IP地址、子网掩码和默认网关。要想这两台电脑通信，这三项必须配置成为一个网络，可以一个是192.168.0.1/24，另一个是192.168.0.2/24，否是是不通的。到此为止，两台电脑已经构成了一个最小的**局域网**，也即**LAN**。可以玩联机局域网游戏啦！

那怎么把三台电脑连在一起呢？使用一个叫做**Hub**的东西，也就是**集线器**。这种设备有多个口，可以将多台电脑连接起来。但是，和交换机不同，集线器没有大脑，它完全在物理层工作。它会将自己接收到的每一个字节，都复制到其他端口上去。这是第一层物理层联通的方案。

### 第二层（数据链路层）
你可能已经发现了，Hub采取的是广播的模式，如果每一台电脑发出的包，集线器上的每个电脑都能收到，那就麻烦了。这就需要解决几个问题：
1. 这个包是发给谁的？谁应该接收？
2. 大家都在发，会不会产生混乱？有没有谁先发、谁后发的规则？
3. 如果发送的时候出现了错误，怎么办？

这几个问题，都是第二层，数据链路层，也即MAC层要解决的问题。**MAC**的全称是**Medium Access Control**，即**媒体访问控制**。**控制什么呢？其实就是控制在往媒体上发数据的时候，谁先发、谁后发的问题。防止发生混乱。这解决的是第二个问题。这个问题中的规则，学名叫多路访问**。有很多算法可以解决这个问题。就像车管所管束马路上跑的车，比如接下来这三种方式：
+ 方式一：分多个车道。每个车一个车道，你走你的，我走我的。这在计算机网络里叫作**信道划分**
+ 方式二：今天单号出行，明天双号出行，轮着来。这在计算机网络里面叫作**轮流协议**
+ 方式三：不管三七二十一，有事儿先出门，发现特堵，就回去。错过高峰再出。我们叫作**随机接入协议**。著名的以太网，用的就是这个方式

解决了第二个问题，就是解决了媒体接入控制的问题，MAC的问题也就解决好了。这和MAC地址没什么关系。

接下来要解决第一个问题：发给谁，谁接收？这里用到一个物理地址，叫作**链路层地址。但是因为第二层主要解决媒体的接入控制的问题，所以它常被称为MAC地址**。解决第一个问题就牵扯到第二层的网络包**格式**。对于以太网，第二层的最开始，就是目标的MAC地址和源的MAC地址。
![](https://pic.downk.cc/item/5e6f519be83c3a1e3a7eb14a.png)

接下里是**类型**，大部分的类型是IP数据包，然后IP里面包含TCP、UDP，以及HTTP等，这都是里层封装的事情。

对于以太网，第二层的最后面是**CRC**，也就是**循环冗余检测**。通过XOR异或的算法，来计算整个包是否在发送的过程中出现了错误，主要解决第三个问题。

这里还有一个没有解决的问题，当源机器知道目标机器的时候，可以将目标地址放入包里面，如果不知道呢？一个广播的网络里面接入了N机器，我怎么知道每个MAC地址是谁呢？这就是**ARP协议**，也就是已知IP地址，求MAC地址的协议。
![](https://pic.downk.cc/item/5e6f59a0e83c3a1e3a83f31f.jpg)
在一个局域网里面，当知道了IP地址，不知道MAC怎么办呢？靠“吼”。
![](https://pic.downk.cc/item/5e6f59a0e83c3a1e3a83f31f.jpg)
广而告之，发送一个广播包，谁是这个IP谁来回答。具体询问和回答的报文就像下面这样：
![](https://pic.downk.cc/item/5e6f62d4e83c3a1e3a8821ea.png)
为了避免每次都用ARP请求，机器本地也会进行ARP缓存。当然机器会不断的上下线，IP也可能会变，所以ARP的MAC地址缓存过一段时间就会过期

### 局域网
这种组网的方式对于少的机器还可以，但是一旦机器数目增多，问题就出现了。因为Hub是广播的，不管某个接口是否需要，所有的Bit都会被发送出去，所有的Bit都会被发送出去，然后让主机来判断是不是需要。但当机器变多时，产生冲突的概率就提高了。而且把不需要的包转发过去，纯属浪费。看来Hub这种不管三七二十一都转发的设备是不行了，需要点智能的。因为每个口都只连接一台电脑，这台电脑又不怎么换IP和MAC地址，只要记住这台电脑的MAC地址，如果目标MAC地址不是这台电脑的，这个口就不用转发了。这就需要一个能把MAC头拿下来，检查一下目标MAC地址，然后根据策略转发的设备，这个设备显然是个二层设备，我们称为**交换机**。

交换机怎么知道每个口的电脑的MAC地址呢？这需要交换机会学习，一台MAC1电脑将一个包发送给另一台MAC2电脑，一开始交换机也不知道MAC2的电脑在哪个口，所以它只能将包转发给除了来的那个口之外的其他所有口并记住MAC1来自哪个口。这样过了一段时间之后，就有了整个网络的一个结构，这个时候，基本上不用广播了，全部可以准确转发。当然，每个机器的IP地址会变，所在的口也会变，因而交换机上的学习的结果，我们称为**转发表**，是有过期时间的。